#! /bin/bash

name=""
layout=even-horizontal

while [[ "$1" =~ ^- ]]; do
	case "$1" in
		--) shift; break;;
		-n) name="$2"; shift 2;;
		-v) layout=even-vertical; shift;;
		-t) layout=tiled; shift;;
		*)
			echo "unrecognised argument $1"
			exit 1
			;;
	esac
done

if [[ "$name" == "" ]]; then
	name=$(head -c4 /dev/urandom | xxd -ps)
fi

tmux new-session -n main -ds "$name"
tmux send-keys "$1" C-m
tmux select-layout "$layout"
shift 1

setup-rest() {
	sleep 0.1
	for cmd in "$@"; do
		tmux new-window -n temp -t "$name"
		tmux send-keys "$cmd" C-m
		tmux join-pane -s temp -t main 2>/dev/null
		tmux select-layout "$layout"
	done

	tmux select-layout "$layout"
	tmux setw synchronize-panes on
}

setup-rest "$@" &

tmux a -t "$name"

